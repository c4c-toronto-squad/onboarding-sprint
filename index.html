<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Vision Zero Sprint</title>
<script src="https://d3js.org/d3.v5.min.js"></script>

<!-- Bootstrap CDN -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

<link href="https://fonts.googleapis.com/css?family=Signika" rel="stylesheet">

<style>
* {
  box-sizing: border-box;
}

html, body, #map {
  font-family: 'Signika', sans-serif;
  min-width: 960px;
  min-height: 100%;
  height: 100%;
  padding: 0;
  margin: 0;
}

#root {
  height: 100%;
  width: 100%;

  display: flex;
  flex-direction: column;

  overflow: none;
}

#top {
  width: 100%;
  height: 60px;
}

#logo {
  width: 305px;
  margin: 10px 0 0 38px;
}

#content {
  width: 100%;
  height: calc(100% - 60px);

  display: flex;
  flex-direction: row;
}

#left {
  height: 100%;
  width: 337px;
  display: flex;
  flex-direction: column;
}

#vz {
  color: #539fc5;
}

#vz > h2 {
  font-size: 22px;
  margin-top: 22px;
}

#vz > p {
  margin-bottom: 22px;
}

#controls > h3 {
  color: #3f728c;
  font-size: 14px;
  font-weight: 700;
  margin-top: 14px;
  text-transform: uppercase;
}

.left-section {
  padding-left: 45px;
}

.btn-outline-primary {
  color: #075075;
  border-color: #075075;
}

.intervention {
  cursor: pointer;
}

.intervention-icon {
  display: inline-block;
  width: 64px;
  height: 64px;
  float: left;
  margin-right: 5px;
}

#main {
  width: calc(100% - 337px);
  height: calc(100% - 141px);
}

#bottom {
  height: 141px;
  width: 100%;
}

.collisions {
  position: absolute;
}

circle.collision.collision-fatal {
  fill: #b249f4;
  fill-opacity: 0.5;
}

circle.collision.collision-injury {
  fill: #eda7ff;
  fill-opacity: 0.5;
}

circle.collision {
  fill: #aaa;
  fill-opacity: 0.25;
}

</style>
</head>
<body>
<form id="form_query"></form>
<div id="root">
  <div id="top" class="border-bottom">
    <img id="logo" src="/img/vz_logo.svg" alt="Vision Zero Viewpoints" />
  </div>
  <div id="content">
    <div id="left" class="border-right">
      <div id="vz" class="left-section border-bottom">
        <h2>In 2017, 45 lives were lost on Toronto’s streets.</h2>
        <p>
The Vision Zero Road Safety Plan is a comprehensive five year (2017-2021) action plan focused on reducing traffic-related fatalities and serious injuries on Toronto’s streets.
        </p>
      </div>
      <div id="controls" class="left-section border-bottom">
        <h3>Collision Impact</h3>
        <div class="legend-entry">
          <svg width="10" height="10" class="legend-icon">
            <circle class="collision collision-fatal" r="5" cx="5" cy="5"></circle>
          </svg>
          <span>Fatalities</span>
        </div>
        <div class="legend-entry">
          <svg width="10" height="10" class="legend-icon">
            <circle class="collision collision-injury" r="5" cx="5" cy="5"></circle>
          </svg>
          <span>Injuries</span>
        </div>
        <div class="legend-entry">
          <svg width="10" height="10" class="legend-icon">
            <circle class="collision" r="5" cx="5" cy="5"></circle>
          </svg>
          <span>Other</span>
        </div>

        <h3>Viewpoint</h3>
        <div class="btn-group btn-group-toggle" data-toggle="buttons" role="group" aria-label="Demographic">
          <label class="btn btn-outline-primary">
            <input type="radio" form="form_query" name="demographic" id="demographic_child" autocomplete="off" value="CHILD"> Child
          </label>
          <label class="btn btn-outline-primary">
            <input type="radio" form="form_query" name="demographic" id="demographic_adult" autocomplete="off" value="ADULT"> Adult
          </label>
          <label class="btn btn-outline-primary">
            <input type="radio" form="form_query" name="demographic" id="demographic_senior" autocomplete="off" value="SENIOR"> Senior
          </label>
        </div>

        <h3>Mode of transport</h3>
        <div class="btn-group btn-group-toggle" data-toggle="buttons" role="group" aria-label="Mode of transport">
          <label class="btn btn-outline-primary">
            <input type="radio" form="form_query" name="transport" id="transport_walking" autocomplete="off" value="WALKING">
            <img src="/img/pedestrian.svg" alt="Walking" width="32" height="32" />
          </label>
          <label class="btn btn-outline-primary">
            <input type="radio" form="form_query" name="transport" id="transport_cycling" autocomplete="off" value="CYCLING">
            <img src="/img/cyclist.svg" alt="Cycling" width="32" height="32" />
          </label>
          <label class="btn btn-outline-primary">
            <input type="radio" form="form_query" name="transport" id="transport_driving" autocomplete="off" value="DRIVING">
            <img src="/img/motorist.svg" alt="Driving" width="32" height="32" />
          </label>
          <label class="btn btn-outline-primary">
            <input type="radio" form="form_query" name="transport" id="transport_transit" autocomplete="off" value="TRANSIT">
            <img src="/img/transit.svg" alt="Transit" width="32" height="32" />
          </label>
        </div>
      </div>
      <div id="interventions" class="left-section">
        <h2>Interventions</h2>
        <div class="list-group">
          <button class="intervention list-group-item list-group-item-action">
            <img class="intervention-icon border rounded-circle" src="/img/separated.jpg" alt="Separated Bike Lane" />
            <p class="intervention-description">
              Separated bike lanes are awesome.
            </p>
          </button>
          <button class="intervention list-group-item list-group-item-action">
            <img class="intervention-icon border rounded-circle" src="/img/separated.jpg" alt="Separated Bike Lane" />
            <p class="intervention-description">
              Separated bike lanes are awesome.
            </p>
          </button>
        </div>
      </div>
    </div>
    <div id="main">
      <div id="map"></div>
      <div id="bottom" class="border-top">
        <div id="context">

        </div>
      </div>
    </div>
  </div>
</div>
<script>
const TORONTO_CENTROID = {lat: 43.6986, lng: -79.3854};



// hide unneeded features to focus on roads
// see https://snazzymaps.com/style/7846/roads-only
const styles = [
    {
        "featureType": "all",
        "elementType": "labels.text.fill",
        "stylers": [
            {
                "color": "#ffffff"
            }
        ]
    },
    {
        "featureType": "all",
        "elementType": "labels.text.stroke",
        "stylers": [
            {
                "visibility": "on"
            },
            {
                "color": "#3e606f"
            },
            {
                "weight": 2
            },
            {
                "gamma": 0.84
            }
        ]
    },
    {
        "featureType": "all",
        "elementType": "labels.icon",
        "stylers": [
            {
                "visibility": "off"
            }
        ]
    },
    {
        "featureType": "administrative",
        "elementType": "all",
        "stylers": [
            {
                "visibility": "off"
            }
        ]
    },
    {
        "featureType": "landscape",
        "elementType": "geometry",
        "stylers": [
            {
                "color": "#2c5a71"
            }
        ]
    },
    {
        "featureType": "poi",
        "elementType": "geometry",
        "stylers": [
            {
                "color": "#406d80"
            }
        ]
    },
    {
        "featureType": "poi.park",
        "elementType": "geometry",
        "stylers": [
            {
                "color": "#2c5a71"
            }
        ]
    },
    {
        "featureType": "road",
        "elementType": "geometry",
        "stylers": [
            {
                "color": "#29768a"
            },
            {
                "lightness": -37
            }
        ]
    },
    {
        "featureType": "transit",
        "elementType": "geometry",
        "stylers": [
            {
                "color": "#406d80"
            }
        ]
    },
    {
        "featureType": "water",
        "elementType": "geometry",
        "stylers": [
            {
                "color": "#193341"
            }
        ]
    }
];

const CollisionSeverity = {
  NORMAL: 0,
  INJURY: 1,
  FATAL: 2
};

const $map = document.getElementById('map');
const form = document.forms.form_query;
let dataKSI = [];
let dataIntervention = [];
let map = null;
let layer = null;
let overlay = null;
let hasIntervention = false;

function getQuery() {
  let demographic = form.demographic.value;
  if (!demographic) {
    demographic = null;
  }
  let transport = form.transport.value;
  if (!transport) {
    transport = null;
  }
  return {
    demographic,
    transport
  };
}

function getKSIDemographic(d) {
  const age = parseInt(d.INVAGE, 10);
  if (Number.isNaN(age)) {
    return null;
  }
  if (age < 20) {
    /*
     * We only get 5-year brackets here, so assume that "15 to 19" is usually
     * a child.
     */
    return 'CHILD';
  } else if (age < 65) {
    return 'ADULT';
  } else {
    return 'SENIOR';
  }
  return parseDemographic(d.INVAGE);
}

function getKSITransport(d) {
  if (d.VEHTYPE === 'Municipal Transit Bus (TTC)') {
    return 'TRANSIT';
  } else if (d.INVTYPE === 'Pedestrian') {
    return 'WALKING';
  } else if (d.INVTYPE === 'Cyclist') {
    return 'CYCLING';
  } else {
    return 'DRIVING';
  }
}

function getKSISeverity(d) {
  switch (d.ACCLASS) {
  case 'Fatal':
    return CollisionSeverity.FATAL;
  case 'Non-Fatal Injury':
    return CollisionSeverity.INJURY;
  default:
    return CollisionSeverity.NORMAL;
  }
}

function getEventSeverity(d) {
  switch (d.collision_type) {
  case 'FATAL':
    return CollisionSeverity.FATAL;
  case 'NON-FATAL INJURY':
    return CollisionSeverity.INJURY;
  default:
    return CollisionSeverity.NORMAL;
  }
}

function getInvolvedDemographic(d) {
  const age = parseInt(d.involved_age, 10);
  if (Number.isNaN(age)) {
    return null;
  }
  if (age < 18) {
    return 'CHILD';
  } else if (age < 65) {
    return 'ADULT';
  } else {
    return 'SENIOR';
  }
}

function getInvolvedTransport(d) {
  if (d.vehicle_class === 'MUNICIPAL TRANSIT BUS (TTC)') {
    return 'TRANSIT';
  } else if (d.involved_class === 'PEDESTRIAN') {
    return 'WALKING';
  } else if (d.involved_class === 'CYCLIST') {
    return 'CYCLING';
  } else {
    return 'DRIVING';
  }
}

function promiseKSI() {
  return d3.csv('/data/KSI.csv', d => {
    const date = new Date(d.DATE).valueOf();
    const timeOfDay = parseInt(d.TIME, 10);
    const mins = Math.floor(timeOfDay / 100) * 60 + timeOfDay % 100;

    const t = new Date(date + mins * 60 * 1000);
    const lat = parseFloat(d.Y);
    const lng = parseFloat(d.X);
    const demographic = getKSIDemographic(d);
    const transport = getKSITransport(d);
    const severity = getKSISeverity(d);

    return {t, lat, lng, demographic, transport, severity};
  });
}

function promiseEvents() {
  return d3.csv('/data/events_filtered.csv', d => {
    const date = new Date(d.collision_date).valueOf();
    const timeOfDay = parseInt(d.collision_time, 10);
    const mins = Math.floor(timeOfDay / 100) * 60 + timeOfDay % 100;

    const id = parseInt(d.collision_id, 10);
    const t = new Date(date + mins * 60 * 1000);
    const lat = parseFloat(d.latitude);
    const lng = parseFloat(d.longitude);
    const severity = getEventSeverity(d);

    return {id, t, lat, lng, severity};
  });
}

function promiseInvolved() {
  return d3.csv('/data/involved_filtered.csv', d => {
    const id = parseInt(d.collision_id, 10);
    const demographic = getInvolvedDemographic(d);
    const transport = getInvolvedTransport(d);

    return {id, demographic, transport};
  });
}

function promiseIntervention() {
  const promises = [
    promiseEvents(),
    promiseInvolved()
  ];
  return Promise.all(promises)
    .then(([events, involved]) => {
      return events;
    });
}

function init() {
  promiseKSI().then(data => {
    dataKSI = data;
    initMap(dataKSI);
    initControls();
  });
}

function initMap(data) {
  map = new google.maps.Map($map, {
    center: TORONTO_CENTROID,
    zoom: 11,
    // disable pan / zoom for now
    gestureHandling: 'none',
    // disable unneeded controls
    fullscreenControl: false,
    mapTypeControl: false,
    streetViewControl: false,
    zoomControl: false,
    // styles (see above)
    styles
  });

  overlay = new google.maps.OverlayView();

  // Add the container when the overlay is added to the map.
  overlay.onAdd = function() {
    const {width, height} = $map.getBoundingClientRect();
    const halfWidth = width / 2;
    const halfHeight = height / 2;
    layer = d3.select(overlay.getPanes().overlayLayer).append('svg')
      .attr('class', 'collisions')
      .style('left', `${-halfWidth}px`)
      .style('top', `${-halfHeight}px`)
      .attr('width', width)
      .attr('height', height)
      .attr('viewBox', `${-halfWidth} ${-halfHeight} ${width} ${height}`)
      .attr('xmlns', 'http://www.w3.org/2000/svg');

    overlay.draw = redrawMarkers;
  };

  overlay.setMap(map);
}

function interventionClicked() {
  promiseIntervention().then(data => {
    dataIntervention = data;
    redrawMarkers();

    const bounds = new google.maps.LatLngBounds();
    bounds.extend(new google.maps.LatLng(43.639135, -79.421064));
    bounds.extend(new google.maps.LatLng(43.666530, -79.338263));
    map.fitBounds(bounds);
  });
}

function matchesQuery(query) {
  return d => {
    const {demographic, transport} = query;
    if (demographic !== null && demographic !== d.demographic) {
      return false;
    }
    if (transport !== null && transport !== d.transport) {
      return false;
    }
    return true;
  };
}

function redrawMarkers() {
  const projection = overlay.getProjection();

  const query = getQuery();
  let data = hasIntervention ? dataIntervention : dataKSI;
  data = data.filter(matchesQuery(query));
  data = data.slice(0, 1000);
  console.log(data.length);

  const markers = layer.selectAll('circle')
    .data(data, d => d.id);
  markers.enter().append('circle')
      .classed('collision', true)
      .classed('collision-injury', d => d.severity === CollisionSeverity.INJURY)
      .classed('collision-fatal', d => d.severity === CollisionSeverity.FATAL)
      .attr('r', 5)
      .merge(markers)
      .each(transform);
  markers.exit().remove();

  function transform(d) {
    d = new google.maps.LatLng(d.lat, d.lng);
    d = projection.fromLatLngToDivPixel(d);
    return d3.select(this)
      .attr('cx', d.x)
      .attr('cy', d.y);
  }
}

function initRadio(radio) {
  radio.onchange = redrawMarkers;
}

function initControls() {
  form.demographic.forEach(initRadio);
  form.transport.forEach(initRadio);

  const $interventions = document.querySelectorAll('.intervention');
  $interventions.forEach($intervention => {
    $intervention.onclick = evt => {
      $interventions.forEach($intervention => {
        $intervention.classList.remove('active');
      })
      $intervention.classList.add('active');

      // zoom to intervention!  WIZARD OF OZ
      if (!hasIntervention) {
        interventionClicked();
      }
      hasIntervention = true;
    };
  });
}
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCKZYcFPS95XmFWNZ1o6EWTNORJvTPm7lo&callback=init" async defer></script>
</body>
</html>
