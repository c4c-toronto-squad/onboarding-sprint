<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Vision Zero Sprint</title>
<script src="https://d3js.org/d3.v5.min.js"></script>

<style>
html, body, #map {
  min-width: 960px;
  min-height: 100%;
  height: 100%;
  padding: 0;
  margin: 0;
}

.collisions {
  position: absolute;
}

circle.collision {
  fill: blue;
  fill-opacity: 0.1;
}
</style>
</head>
<body>
<div id="map"></div>
<script>
const TORONTO_CENTROID = {lat: 43.6986, lng: -79.3854};

function init() {
  d3.csv('/KSI.csv', d => {
    const date = new Date(d.DATE).valueOf();
    const timeOfDay = parseInt(d.TIME, 10);
    const mins = Math.floor(timeOfDay / 100) * 60 + timeOfDay % 100;
    const t = new Date(date + mins * 60 * 1000);
    const lat = parseFloat(d.Y);
    const lng = parseFloat(d.X);
    return {t, lat, lng};
  }).then(initMap);
}

function initMap(data) {
  const $map = document.getElementById('map');
  const map = new google.maps.Map($map, {
    center: TORONTO_CENTROID,
    zoom: 11,
    mapTypeControl: false,
    streetViewControl: false,
    fullscreenControl: false
  });

  const overlay = new google.maps.OverlayView();
  data = data.slice(0, 1000);

  // Add the container when the overlay is added to the map.
  overlay.onAdd = function() {
    const {width, height} = $map.getBoundingClientRect();
    const layer = d3.select(this.getPanes().overlayLayer).append('svg')
      .attr('class', 'collisions')
      .style('left', `${-width / 2}px`)
      .style('top', `${-height / 2}px`)
      .attr('width', width)
      .attr('height', height);

    // Draw each marker as a separate SVG element.
    // We could use a single SVG, but what size would it have?
    overlay.draw = function() {
      const projection = this.getProjection();

      const markers = layer.selectAll('circle');

      markers
        .data(data)
        .enter().append('circle')
          .classed('collision', true)
          .attr('r', 5);

      markers.each(transform)

      function transform(d) {
        d = new google.maps.LatLng(d.lat, d.lng);
        d = projection.fromLatLngToDivPixel(d);
        return d3.select(this)
          .attr('cx', d.x + width / 2)
          .attr('cy', d.y + height / 2);
      }
    };
  };

  overlay.setMap(map);
}
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCKZYcFPS95XmFWNZ1o6EWTNORJvTPm7lo&callback=init" async defer></script>
</body>
</html>
