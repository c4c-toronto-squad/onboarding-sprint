<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Vision Zero Sprint</title>
<script src="https://d3js.org/d3.v5.min.js"></script>

<!-- Bootstrap CDN -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

<style>
* {
  box-sizing: border-box;
}

html, body, #map {
  min-width: 960px;
  min-height: 100%;
  height: 100%;
  padding: 0;
  margin: 0;
}

#root {
  height: 100%;
  width: 100%;

  display: flex;
  flex-direction: row;

  overflow: none;
}

#left {
  height: 100%;
  width: 320px;
  display: flex;
  flex-direction: column;
}

.left-section {
  padding: 5px;
}

#interventions > ul {
  height: 320px;
  overflow-y: auto;
}

.intervention-icon {
  display: inline-block;
  width: 64px;
  height: 64px;
  float: left;
  margin-right: 5px;
}

#main {
  width: calc(100% - 320px);
  height: calc(100% - 160px);
}

#bottom {
  height: 160px;
  width: 100%;
}

.collisions {
  position: absolute;
}

circle.collision {
  fill: blue;
  fill-opacity: 0.1;
}

circle.collision.collision-injury {
  fill: yellow;
}

circle.collision.collision-fatal {
  fill: red;
  fill-opacity: 1;
}
</style>
</head>
<body>
<div id="root">
  <div id="left" class="border-right">
    <div id="vz" class="left-section border-bottom">
      <h1>Vision Zero TO</h1>
    </div>
    <div id="legend" class="left-section border-bottom">
      <div class="legend-entry">
        <svg width="10" height="10" class="legend-icon">
          <circle class="collision collision-fatal" r="5" cx="5" cy="5"></circle>
        </svg>
        <span>Fatal collision</span>
      </div>
      <div class="legend-entry">
        <svg width="10" height="10" class="legend-icon">
          <circle class="collision collision-injury" r="5" cx="5" cy="5"></circle>
        </svg>
        <span>Injury-causing collision</span>
      </div>
      <div class="legend-entry">
        <svg width="10" height="10" class="legend-icon">
          <circle class="collision" r="5" cx="5" cy="5"></circle>
        </svg>
        <span>Collision</span>
      </div>
    </div>
    <div id="demographic" class="left-section border-bottom">
      <p>Who do you identify with?</p>
      <div class="btn-group btn-group-toggle" data-toggle="buttons" role="group" aria-label="Demographic">
        <label class="btn btn-outline-secondary active">
          <input type="radio" name="demographic" id="demographic_child" autocomplete="off" checked> Child
        </label>
        <label class="btn btn-outline-secondary">
          <input type="radio" name="demographic" id="demographic_adult" autocomplete="off"> Adult
        </label>
        <label class="btn btn-outline-secondary">
          <input type="radio" name="demographic" id="demographic_senior" autocomplete="off"> Senior
        </label>
      </div>
    </div>
    <div id="transport" class="left-section border-bottom">
      <p>How do you get around?</p>
      <div class="btn-group btn-group-toggle" data-toggle="buttons" role="group" aria-label="Mode of transport">
        <label class="btn btn-outline-secondary active">
          <input type="radio" name="transport" id="transport_walking" autocomplete="off" checked>
          <img src="/img/pedestrian.svg" alt="Walking" width="32" height="32" />
        </label>
        <label class="btn btn-outline-secondary">
          <input type="radio" name="transport" id="transport_cycling" autocomplete="off">
          <img src="/img/cyclist.svg" alt="Cycling" width="32" height="32" />
        </label>
        <label class="btn btn-outline-secondary">
          <input type="radio" name="transport" id="transport_driving" autocomplete="off">
          <img src="/img/motorist.svg" alt="Driving" width="32" height="32" />
        </label>
        <label class="btn btn-outline-secondary">
          <input type="radio" name="transport" id="transport_transit" autocomplete="off">
          <img src="/img/transit.svg" alt="Transit" width="32" height="32" />
        </label>
      </div>
    </div>
    <div id="interventions" class="left-section">
      <h2>Interventions</h2>
      <ul class="list-group list-group-flush">
        <li class="list-group-item">
          <img class="intervention-icon border rounded-circle" src="/img/separated.jpg" alt="Separated Bike Lane" />
          <p class="intervention-description">
            Separated bike lanes are awesome.
          </p>
        </li>
        <li class="list-group-item">
          <img class="intervention-icon border rounded-circle" src="/img/separated.jpg" alt="Separated Bike Lane" />
          <p class="intervention-description">
            Separated bike lanes are awesome.
          </p>
        </li>
        <li class="list-group-item">
          <img class="intervention-icon border rounded-circle" src="/img/separated.jpg" alt="Separated Bike Lane" />
          <p class="intervention-description">
            Separated bike lanes are awesome.
          </p>
        </li>
        <li class="list-group-item">
          <img class="intervention-icon border rounded-circle" src="/img/separated.jpg" alt="Separated Bike Lane" />
          <p class="intervention-description">
            Separated bike lanes are awesome.
          </p>
        </li>
        <li class="list-group-item">
          <img class="intervention-icon border rounded-circle" src="/img/separated.jpg" alt="Separated Bike Lane" />
          <p class="intervention-description">
            Separated bike lanes are awesome.
          </p>
        </li>
        <li class="list-group-item">
          <img class="intervention-icon border rounded-circle" src="/img/separated.jpg" alt="Separated Bike Lane" />
          <p class="intervention-description">
            Separated bike lanes are awesome.
          </p>
        </li>
        <li class="list-group-item">
          <img class="intervention-icon border rounded-circle" src="/img/separated.jpg" alt="Separated Bike Lane" />
          <p class="intervention-description">
            Separated bike lanes are awesome.
          </p>
        </li>
        <li class="list-group-item">
          <img class="intervention-icon border rounded-circle" src="/img/separated.jpg" alt="Separated Bike Lane" />
          <p class="intervention-description">
            Separated bike lanes are awesome.
          </p>
        </li>
        <li class="list-group-item">
          <img class="intervention-icon border rounded-circle" src="/img/separated.jpg" alt="Separated Bike Lane" />
          <p class="intervention-description">
            Separated bike lanes are awesome.
          </p>
        </li>
      </ul>
    </div>
  </div>
  <div id="main">
    <div id="map"></div>
    <div id="bottom" class="border-top">
      <div id="context">

      </div>
    </div>
  </div>
</div>
<script>
const TORONTO_CENTROID = {lat: 43.6986, lng: -79.3854};

// hide unneeded features to focus on roads
// see https://snazzymaps.com/style/7846/roads-only
const styles = [
  {
    "featureType": "administrative",
    "elementType": "all",
    "stylers": [
      {
        "visibility": "off"
      }
    ]
  },
  {
    "featureType": "landscape",
    "elementType": "all",
    "stylers": [
      {
        "visibility": "off"
      }
    ]
  },
  {
    "featureType": "poi",
    "elementType": "all",
    "stylers": [
      {
        "visibility": "off"
      }
    ]
  },
  {
    "featureType": "road",
    "elementType": "all",
    "stylers": [
      {
        "visibility": "on"
      }
    ]
  },
  /*
  {
    "featureType": "road",
    "elementType": "labels",
    "stylers": [
      {
        "visibility": "off"
      }
    ]
  },
  */
  {
    "featureType": "transit",
    "elementType": "all",
    "stylers": [
      {
        "visibility": "on"
      }
    ]
  },
  {
    "featureType": "transit",
    "elementType": "labels",
    "stylers": [
      {
        "visibility": "off"
      }
    ]
  },
  {
    "featureType": "water",
    "elementType": "all",
    "stylers": [
      {
        "visibility": "on"
      }
    ]
  },
  {
    "featureType": "water",
    "elementType": "geometry",
    "stylers": [
      {
        "color": "#12608d"
      }
    ]
  },
  {
    "featureType": "water",
    "elementType": "labels.text.fill",
    "stylers": [
      {
        "visibility": "off"
      }
    ]
  },
  {
    "featureType": "water",
    "elementType": "labels.text.stroke",
    "stylers": [
      {
        "visibility": "off"
      }
    ]
  }
];

const CollisionSeverity = {
  NORMAL: 0,
  INJURY: 1,
  FATAL: 2
};

function getCollisionSeverity(d) {
  switch (d.collision_type) {
  case 'FATAL':
    return CollisionSeverity.FATAL;
  case 'NON-FATAL INJURY':
    return CollisionSeverity.INJURY;
  default:
    return CollisionSeverity.NORMAL;
  }
}

function init() {
  d3.csv('/data/events_filtered.csv', d => {
    const date = new Date(d.collision_date).valueOf();
    const timeOfDay = parseInt(d.collision_time, 10);
    const mins = Math.floor(timeOfDay / 100) * 60 + timeOfDay % 100;
    const t = new Date(date + mins * 60 * 1000);
    const lat = parseFloat(d.latitude);
    const lng = parseFloat(d.longitude);

    const severity = getCollisionSeverity(d);
    return {t, lat, lng, severity};
  }).then(initMap);
}

function initMap(data) {
  const $map = document.getElementById('map');
  const map = new google.maps.Map($map, {
    center: TORONTO_CENTROID,
    zoom: 11,
    // disable unneeded controls
    mapTypeControl: false,
    streetViewControl: false,
    fullscreenControl: false,
    styles
  });

  const bounds = new google.maps.LatLngBounds();
  /*
   * Focus on Richmond / Adelaide area.
   */
  bounds.extend(new google.maps.LatLng(43.639135, -79.421064));
  bounds.extend(new google.maps.LatLng(43.666530, -79.338263));
  map.fitBounds(bounds);

  const overlay = new google.maps.OverlayView();
  data = data.slice(0, 10000);

  // Add the container when the overlay is added to the map.
  overlay.onAdd = function() {
    const {width, height} = $map.getBoundingClientRect();
    const halfWidth = width / 2;
    const halfHeight = height / 2;
    const layer = d3.select(this.getPanes().overlayLayer).append('svg')
      .attr('class', 'collisions')
      .style('left', `${-halfWidth}px`)
      .style('top', `${-halfHeight}px`)
      .attr('width', width)
      .attr('height', height)
      .attr('viewBox', `${-halfWidth} ${-halfHeight} ${width} ${height}`)
      .attr('xmlns', 'http://www.w3.org/2000/svg');

    // Draw each marker as a separate SVG element.
    // We could use a single SVG, but what size would it have?
    overlay.draw = function() {
      const projection = this.getProjection();

      const markers = layer.selectAll('circle');

      markers
        .data(data)
        .enter().append('circle')
          .classed('collision', true)
          .classed('collision-injury', d => d.severity === CollisionSeverity.INJURY)
          .classed('collision-fatal', d => d.severity === CollisionSeverity.FATAL)
          .attr('r', 5)

      markers.each(transform);

      function transform(d) {
        d = new google.maps.LatLng(d.lat, d.lng);
        d = projection.fromLatLngToDivPixel(d);
        return d3.select(this)
          .attr('cx', d.x)
          .attr('cy', d.y);
      }
    };
  };

  overlay.setMap(map);
}
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCKZYcFPS95XmFWNZ1o6EWTNORJvTPm7lo&callback=init" async defer></script>
</body>
</html>
